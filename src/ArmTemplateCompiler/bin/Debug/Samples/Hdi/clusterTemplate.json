{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        /*Required settings */
        "Location": {
            "type": "string",
            "allowedValues": [
                "East Asia",
                "West US",
                "East US"
            ],
        },
        "subscriptionId": {
            "type": "string",
        },
        "nodeTemplateUri": {
            "type": "string",
        },
        "gwNodeTemplateUri": {
            "type": "string",
        },
        "NamePrefix": {
            "type": "string"
        },
        /*Optional settings*/
        "httpPort": {
            "defaultValue": 80,
            "type": "int"
        },
        "AdminUsername": {
            "type": "string",
            "defaultValue": "hdiuser"
        },
        "AdminPassword": {
            "type": "securestring",
            "defaultValue": "HdInsight123!"
        },
        "LinuxVMImageUris": {
            "type": "array"
        },
        "WindowsVMImageUris": {
            "type": "array"
        },
        "NumberOfWorkerVms": {
            "type": "int"
        }
    },
    "variables": {
        "virtualNetworkName": "[concat(parameters('NamePrefix'),'-vnet')]",
        "subnetName": "subnet",
        "dnsName": "[parameters('NamePrefix')]",
        "gwAvailabilitySetName": "[concat(parameters('NamePrefix'),'-gw')]",
        "gwNicPrefix": "[concat('nic-',variables('gwAvailabilitySetName'),'-')]",
        "lbNameGW": "[concat(parameters('NamePrefix'), '-LB-GW')]",
        "lbIPNameGW": "[concat(parameters('NamePrefix'), '-PublicIP-LB-GW')]",
        "lbIPIDGW": "[resourceId('Microsoft.Network/publicIPAddresses',variables('lbIPNameGW'))]",
        "lbIDGW": "[resourceId('Microsoft.Network/loadBalancers',variables('lbNameGW'))]",
        "numGatewayVms": 2,
        "hnAvailabilitySetName": "[concat(parameters('NamePrefix'),'-hn')]",
        "hnNicPrefix": "[concat('nic-',variables('hnAvailabilitySetName'),'-')]",
        "lbNameHN": "[concat(parameters('NamePrefix'), '-LB-HN')]",
        "lbIPNameHN": "[concat(parameters('NamePrefix'), '-PublicIP-LB-HN')]",
        "lbIPIDHN": "[resourceId('Microsoft.Network/publicIPAddresses',variables('lbIPNameHN'))]",
        "lbIDHN": "[resourceId('Microsoft.Network/loadBalancers',variables('lbNameHN'))]"
    },
    "scripts": {
        "beforeResourceEval": [
            {
                "uri": "commonFunctions.js"
            }
        ],

        "afterResourceEval": [
            {
                "uri": "workerNodeAvailabilitySetGenerator.js",
            }

        ]
    },
    "resources": [
            {
                "apiVersion": "2014-12-01-preview",
                "type": "Microsoft.Network/virtualNetworks",
                "name": "[variables('virtualNetworkName')]",
                "location": "[parameters('Location')]",
                "properties": {
                    "addressSpace": {
                        "addressPrefixes": [
                            "10.0.0.0/16"
                        ]
                    },
                    "subnets": [
                        {
                            "name": "[variables('subnetName')]",
                            "properties": {
                                "addressPrefix": "10.0.0.0/24"
                            }
                        }
                    ]
                }
            },
            /*Create a public IP with a dnsname lable for our Gateway LB*/
            {
                "apiVersion": "2014-12-01-preview",
                "type": "Microsoft.Network/publicIPAddresses",
                "name": "[variables('lbIPNameGW')]",
                "location": "[parameters('Location')]",
                "properties": {
                    "publicIPAllocationMethod": "Dynamic",
                    "dnsSettings": {
                        "domainNameLabel": "[variables('dnsName')]"
                    }
                }
            },
            /*Create a public IP with a dnsname lable for our HeadNode LB*/
            {
                "apiVersion": "2014-12-01-preview",
                "type": "Microsoft.Network/publicIPAddresses",
                "name": "[variables('lbIPNameHN')]",
                "location": "[parameters('Location')]",
                "properties": {
                    "publicIPAllocationMethod": "Dynamic",
                    "dnsSettings": {
                        "domainNameLabel": "[concat(variables('dnsName'),'ssh')]"
                    }
                }
            },
            /*deploy headnodes*/
            {
                "name": "sub-deployment-headnode",
                "type": "Microsoft.Resources/deployments",
                "apiVersion": "2015-01-01",
                "dependsOn": [
                    "[concat('Microsoft.Network/virtualNetworks/',variables('virtualNetworkName'))]"
                ],
                "properties": {
                    "mode": "Incremental",
                    "templateLink": {
                        "uri": "[parameters('nodeTemplateUri')]",
                        "contentVersion": "1.0.0.0"
                    },
                    "parameters": {
                        "AvailabilitySetName": { "value": "[concat(parameters('NamePrefix'),'-hn')]" },
                        "Location": { "value": "[parameters('Location')]" },
                        "NumberOfVirtualMachines": { "value": 2 },
                        "VirtualNetworkSettings": {
                            "value": {
                                "virtualNetworkName": "[variables('virtualNetworkName')]",
                                "subnetName": "subnet"
                            }
                        },
                        "VmImageSettings": {
                            "value": "[placeVms(LinuxImages, 2, 'headnode')]"
                        }
                    }
                }
            },
            /*deploy gateway nodes*/
            {
                "name": "sub-deployment-gateway",
                "type": "Microsoft.Resources/deployments",
                "apiVersion": "2015-01-01",
                "dependsOn": [
                    "[concat('Microsoft.Network/virtualNetworks/',variables('virtualNetworkName'))]"
                ],
                "properties": {
                    "mode": "Incremental",
                    "templateLink": {
                        "uri": "[parameters('gwNodeTemplateUri')]",
                        "contentVersion": "1.0.0.0"
                    },
                    "parameters": {
                        "AvailabilitySetName": { "value": "[concat(parameters('NamePrefix'),'-gw')]" },
                        "Location": { "value": "[parameters('Location')]" },
                        "NumberOfVirtualMachines": { "value": 2 },
                        "VirtualNetworkSettings": {
                            "value": {
                                "virtualNetworkName": "[variables('virtualNetworkName')]",
                                "subnetName": "subnet"
                            }
                        },
                        "VmImageSettings": {
                            "value": "[placeVms(WindowsImages,2, 'gateway')]"
                        }
                    }
                }
            },
            /*deploy zookeeper nodes*/
            {
                "name": "sub-deployment-zookeeper",
                "type": "Microsoft.Resources/deployments",
                "apiVersion": "2015-01-01",
                "dependsOn": [
                    "[concat('Microsoft.Network/virtualNetworks/',variables('virtualNetworkName'))]"
                ],
                "properties": {
                    "mode": "Incremental",
                    "templateLink": {
                        "uri": "[parameters('nodeTemplateUri')]",
                        "contentVersion": "1.0.0.0"
                    },
                    "parameters": {
                        "AvailabilitySetName": { "value": "[concat(parameters('NamePrefix'),'-zk')]" },
                        "Location": { "value": "[parameters('Location')]" },
                        "NumberOfVirtualMachines": { "value": 3 },
                        "VmSize": { "value": "Standard_A2" },
                        "VirtualNetworkSettings": {
                            "value": {
                                "virtualNetworkName": "[variables('virtualNetworkName')]",
                                "subnetName": "subnet"
                            }
                        },
                        "VmImageSettings": {
                            "value": "[placeVms(LinuxImages, 3, 'zkNode')]"
                        }
                    }
                }
            },
            /*LB for GW*/
            {
                "apiVersion": "2014-12-01-preview",
                "name": "[variables('lbNameGW')]",
                "type": "Microsoft.Network/loadBalancers",
                "location": "[parameters('Location')]",
                "dependsOn": [
                    "Microsoft.Resources/deployments/sub-deployment-gateway",
                    "[concat('Microsoft.Network/publicIPAddresses/', variables('lbIPNameGW'))]"
                ],
                "properties": {
                    "frontendIPConfigurations": [
                        {
                            "name": "LBFE",
                            "properties": {
                                "publicIPAddress": {
                                    "id": "[variables('lbIPIDGW')]"
                                }
                            }
                        }
                    ],
                    "backendAddressPools": [
                        {
                            "name": "LBBE",
                            "properties": {
                                "backendIPConfigurations": [
                                    {
                                        "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(variables('gwNicPrefix'),'0')),'/ipConfigurations/ipConfig1')]"
                                    },
                                    {
                                        "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(variables('gwNicPrefix'),'1')),'/ipConfigurations/ipConfig1')]"
                                    }
                                ]
                            }
                        }
                    ],
                    "inboundNatRules": [

                        {
                            "name": "RDP",
                            "properties": {
                                "frontendIPConfigurations": [
                                    {
                                        "id": "[concat(variables('lbIDGW'),'/frontendIPConfigurations/LBFE')]"
                                    }
                                ],
                                "backendIPConfiguration": {
                                    "id": "[concat(resourceId('Microsoft.Network/networkInterfaces', concat(variables('gwNicPrefix'),'0')),'/ipConfigurations/ipConfig1')]"
                                },
                                "protocol": "tcp",
                                "frontendPort": 3389,
                                "backendPort": 3389,
                                "enableFloatingIP": false
                            }
                        }
                    ],
                    "loadBalancingRules": [
                        {
                            "name": "LBHttpRule",
                            "properties": {
                                "frontendIPConfigurations": [
                                    {
                                        "id": "[concat(variables('lbIDGW'),'/frontendIPConfigurations/LBFE')]"
                                    }
                                ],
                                "backendAddressPool": {
                                    "id": "[concat(variables('lbIDGW'),'/backendAddressPools/LBBE')]"
                                },
                                "protocol": "tcp",
                                "frontendPort": "[parameters('httpPort')]",
                                "backendPort": "[parameters('httpPort')]",
                                "enableFloatingIP": "false",
                                "idleTimeoutInMinutes": "5",
                                "probe": {
                                    "id": "[concat(variables('lbIDGW'),'/probes/httpProbe')]"
                                }
                            }
                        }
                    ],
                    "probes": [
                        {
                            "name": "httpProbe",
                            "properties": {
                                "protocol": "tcp",
                                "port": "[parameters('httpPort')]",
                                "intervalInSeconds": "5",
                                "numberOfProbes": "2"
                            }
                        }
                    ]
                }
            },
            /*LB for HN*/
            {
                "apiVersion": "2014-12-01-preview",
                "name": "[variables('lbNameHN')]",
                "type": "Microsoft.Network/loadBalancers",
                "location": "[parameters('Location')]",
                "dependsOn": [
                    "Microsoft.Resources/deployments/sub-deployment-headnode",
                    "[concat('Microsoft.Network/publicIPAddresses/', variables('lbIPNameHN'))]"
                ],
                "properties": {
                    "frontendIPConfigurations": [
                        {
                            "name": "LBFE",
                            "properties": {
                                "publicIPAddress": {
                                    "id": "[variables('lbIPIDHN')]"
                                }
                            }
                        }
                    ],
                    "backendAddressPools": [
                        {
                            "name": "LBBE",
                            "properties": {
                                "backendIPConfigurations": [
                                    {
                                        "id": "[concat(resourceId('Microsoft.Network/networkInterfaces',concat(variables('hnNicPrefix'),'0')),'/ipConfigurations/ipConfig1')]"
                                    },
                                    {
                                        "id": "[concat(resourceId('Microsoft.Network/networkInterfaces',concat(variables('hnNicPrefix'),'1')),'/ipConfigurations/ipConfig1')]"
                                    }
                                ]
                            }
                        }
                    ],
                    "inboundNatRules": [
                        {
                            "name": "SSH1",
                            "properties": {
                                "frontendIPConfigurations": [
                                    {
                                        "id": "[concat(variables('lbIDHN'),'/frontendIPConfigurations/LBFE')]"
                                    }
                                ],
                                "backendIPConfiguration": {
                                    "id": "[concat(resourceId('Microsoft.Network/networkInterfaces',concat(variables('hnNicPrefix'),'0')),'/ipConfigurations/ipConfig1')]"
                                },
                                "protocol": "tcp",
                                "frontendPort": 22,
                                "backendPort": 22,
                                "enableFloatingIP": false
                            }
                        },
                        {
                            "name": "SSH2",
                            "properties": {
                                "frontendIPConfigurations": [
                                    {
                                        "id": "[concat(variables('lbIDHN'),'/frontendIPConfigurations/LBFE')]"
                                    }
                                ],
                                "backendIPConfiguration": {
                                    "id": "[concat(resourceId('Microsoft.Network/networkInterfaces',concat(variables('hnNicPrefix'),'1')),'/ipConfigurations/ipConfig1')]"
                                },
                                "protocol": "tcp",
                                "frontendPort": 23,
                                "backendPort": 22,
                                "enableFloatingIP": false
                            }
                        }
                    ]
                }
            },
        ]
    }